<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GestiÃ³n de Reservas - MotorEntix</title>
  <link rel="stylesheet" th:href="@{/css/panel.admin.css}">
</head>
<body>
  <header>
    <div class="logo">
      <h1>MotorEntix</h1>
    </div>
    <div class="user-info">
      <div class="user-menu">
        <button type="button" class="user-menu-toggle">
          <span class="user-name-label" th:if="${usuario != null}"
                th:text="${usuario.nombre} + ' ' + ${usuario.apellido}">Administrador</span>
          <span class="user-name-label" th:unless="${usuario != null}">Administrador</span>
          <div class="user-avatar" th:if="${usuario != null}" th:text="${usuario.nombre.substring(0, 1)}">A</div>
          <div class="user-avatar" th:unless="${usuario != null}">A</div>
          <span class="user-menu-arrow">â–¾</span>
        </button>
        <div class="user-menu-dropdown">
          <a th:href="@{/admin/mi-perfil}" class="user-menu-item">
            <span>ğŸ‘¤ Mi perfil</span>
          </a>
          <a th:href="@{/editar-perfil}" class="user-menu-item">
            <span>âœï¸ Editar perfil</span>
          </a>
          <div class="user-menu-divider"></div>
          <a th:href="@{/logout}" class="user-menu-item user-menu-item-danger">
            <span>ğŸšª Cerrar sesiÃ³n</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <nav class="sidebar">
      <ul class="sidebar-menu">
        <li class="menu-item">
          <a th:href="@{/admin/mi-perfil}" style="text-decoration: none; color: inherit;">
            <span>ğŸ‘¤</span> Mi Perfil
          </a>
        </li>
        <li class="menu-item">
          <a th:href="@{/admin/vehiculos}" style="text-decoration: none; color: inherit;">
            <span>ğŸš—</span> VehÃ­culos
          </a>
        </li>
        <li class="menu-item">
          <a th:href="@{/admin/inventario}" style="text-decoration: none; color: inherit;">
            <span>ğŸ“¦</span> Inventario
          </a>
        </li>
        <li class="menu-item">
          <a th:href="@{/admin/proveedor}" style="text-decoration: none; color: inherit;">
            <span>ğŸ¢</span> Proveedor
          </a>
        </li>
        <li class="menu-item">
          <a th:href="@{/admin/clientes}" style="text-decoration: none; color: inherit;">
            <span>ğŸ‘¥</span> Clientes
          </a>
        </li>
        <li class="menu-item active">
          <a th:href="@{/admin/reservas}" style="text-decoration: none; color: inherit;">
            <span>ğŸ“‹</span> Reservas
          </a>
        </li>
        <li class="menu-item">
          <a th:href="@{/admin/pagos}" style="text-decoration: none; color: inherit;">
            <span>ğŸ’°</span> Pagos
          </a>
        </li>
      </ul>
    </nav>

    <main class="main-content">
      <div class="page-header">
        <h2 class="page-title">GestiÃ³n de Reservas</h2>
      </div>

      <div class="reservas-page">
        <section class="reservas-card">
          <h3 class="reservas-header-title">
            <span class="icon">ğŸ“‹</span>
            <span>Listado de reservas de clientes</span>
          </h3>
          <p class="reservas-subtitle">Revisa el detalle de las citas reservadas, asigna un trabajador y actualiza el estado de cada reserva.</p>

          <div th:if="${exito}" class="alert alert-success" th:text="${exito}"></div>
          <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

          <p class="reservas-meta">
            <span>Total de reservas:</span>
            <span class="badge" th:text="${reservas != null ? reservas.size() : 0}">0</span>
          </p>

          <div class="table-wrapper" style="margin-top: 1rem;">
            <div th:if="${reservas != null} and !${reservas.empty}"
                 style="display: flex; flex-direction: column; gap: 1rem;">

              <div th:each="res : ${reservas}"
                   style="background: #ffffff; border-radius: 14px; box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08); padding: 1rem 1.25rem; border: 1px solid #e5e7eb; display:flex; flex-direction:column; gap:0.75rem;">

                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
                  <div>
                    <div class="small-text" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; color:#9ca3af;">
                      Reserva #<span th:text="${res.id}"></span>
                    </div>
                    <div class="small-text" th:if="${res.usuario != null}" style="margin-top:0.15rem;">
                      <div style="font-weight:600; color:#111827;" th:text="${res.usuario.nombre} + ' ' + ${res.usuario.apellido}"></div>
                      <div style="color:#6b7280;" th:text="${res.usuario.correo}"></div>
                    </div>
                    <span class="small-text" th:if="${res.usuario == null}">Sin cliente asociado</span>
                  </div>

                  <div style="text-align:right;">
                    <div class="small-text" style="color:#6b7280;">
                      <span style="font-weight:500;">Fecha:</span>
                      <span th:text="${res.fechaReserva}"></span>
                    </div>
                    <div class="small-text" style="color:#6b7280;">
                      <span style="font-weight:500;">Hora:</span>
                      <span th:text="${res.horaReserva}"></span>
                    </div>
                  </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1.25rem; flex-wrap:wrap;">
                  <div style="min-width:180px;">
                    <div class="small-text" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; color:#9ca3af; margin-bottom:0.15rem;">
                      Servicio
                    </div>
                    <div class="small-text" th:if="${res.servicio != null}">
                      <div style="font-weight:500; color:#111827;" th:text="${res.servicio.nombre}"></div>
                      <div style="color:#6b7280;" th:text="${res.servicio.descripcion}"></div>
                    </div>
                    <span class="small-text" th:if="${res.servicio == null}">Sin servicio</span>
                  </div>

                  <form th:action="@{/admin/reservas/actualizar/{id}(id=${res.id})}" method="post"
                        style="display:flex; flex:1; justify-content:flex-end; gap:0.75rem; align-items:flex-end; flex-wrap:wrap;">

                    <div style="display:flex; flex-direction:column; gap:0.25rem; min-width:190px;">
                      <label class="small-text" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; color:#9ca3af;">Trabajador asignado</label>
                      <select name="trabajadorId" class="btn-pill" style="min-width: 180px;">
                        <option value="">-- Sin asignar --</option>
                        <option th:each="trab : ${trabajadores}"
                                th:value="${trab.id_trabajador}"
                                th:text="${trab.usuario != null ? trab.usuario.nombre + ' ' + trab.usuario.apellido : 'Trabajador ' + trab.id_trabajador}"
                                th:selected="${res.servicio != null and res.servicio.trabajador != null} and ${trab.id_trabajador} == ${res.servicio.trabajador.id_trabajador}">
                        </option>
                      </select>
                    </div>

                    <div style="display:flex; flex-direction:column; gap:0.25rem; min-width:170px;">
                      <label class="small-text" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; color:#9ca3af;">Estado</label>
                      <select name="estado" class="btn-pill estado-select"
                              th:classappend="${#strings.equalsIgnoreCase(res.estado, 'pendiente')} ? ' pendiente' : (${#strings.equalsIgnoreCase(res.estado, 'confirmada')} ? ' confirmada' : (${#strings.equalsIgnoreCase(res.estado, 'completada')} ? ' completada' : (${#strings.equalsIgnoreCase(res.estado, 'cancelada')} ? ' cancelada' : '')))">
                        <option value="pendiente" th:selected="${#strings.equalsIgnoreCase(res.estado, 'pendiente')}">Pendiente</option>
                        <option value="confirmada" th:selected="${#strings.equalsIgnoreCase(res.estado, 'confirmada')}">Confirmada</option>
                        <option value="completada" th:selected="${#strings.equalsIgnoreCase(res.estado, 'completada')}">Completada</option>
                        <option value="cancelada" th:selected="${#strings.equalsIgnoreCase(res.estado, 'cancelada')}">Cancelada</option>
                      </select>
                    </div>

                    <div style="display:flex; flex-direction:column; gap:0.3rem;">
                      <button type="submit" class="btn-pill btn-pill-primary">Guardar</button>
                    </div>
                  </form>
                </div>

                <div style="display:flex; justify-content:flex-end; margin-top:0.25rem;">
                  <form th:action="@{/admin/reservas/cancelar/{id}(id=${res.id})}" method="post"
                        onsubmit="return confirm('Â¿Seguro que deseas cancelar esta reserva?');">
                    <button type="submit" class="btn-pill btn-pill-delete">Cancelar</button>
                  </form>
                </div>
              </div>
            </div>

            <div th:if="${reservas == null} or ${reservas.empty}" class="clients-empty" style="margin-top:0.5rem;">
              <span>
                <span>ğŸ“</span>
                <span>No hay reservas registradas todavÃ­a.</span>
              </span>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // Dropdown de usuario en header (todas las instancias .user-menu de la pÃ¡gina)
    document.addEventListener('DOMContentLoaded', function () {
      const userMenus = document.querySelectorAll('.user-menu');
      if (!userMenus.length) return;

      function closeAllMenus() {
        userMenus.forEach(m => m.classList.remove('open'));
      }

      userMenus.forEach(function (userMenu) {
        const toggle = userMenu.querySelector('.user-menu-toggle');
        if (!toggle) return;

        toggle.addEventListener('click', function (event) {
          event.stopPropagation();
          const isOpen = userMenu.classList.contains('open');
          closeAllMenus();
          if (!isOpen) {
            userMenu.classList.add('open');
          }
        });
      });

      document.addEventListener('click', function () {
        closeAllMenus();
      });
    });
  </script>
</body>

</html>
