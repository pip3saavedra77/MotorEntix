<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gesti√≥n de Veh√≠culos - MotorEntix</title>
	<link rel="stylesheet" th:href="@{/css/panel.admin.css}">
</head>

<body>
	<header>
		<div class="logo">
			<h1>MotorEntix</h1>
		</div>
		<div class="user-info">
			<div class="user-menu">
				<button type="button" class="user-menu-toggle">
					<span class="user-name-label" th:if="${usuario != null}"
					      th:text="${usuario.nombre} + ' ' + ${usuario.apellido}">Administrador</span>
					<span class="user-name-label" th:unless="${usuario != null}">Administrador</span>
					<div class="user-avatar" th:if="${usuario != null}" th:text="${usuario.nombre.substring(0, 1)}">A</div>
					<div class="user-avatar" th:unless="${usuario != null}">A</div>
					<span class="user-menu-arrow">‚ñæ</span>
				</button>
				<div class="user-menu-dropdown">
					<a th:href="@{/admin/mi-perfil}" class="user-menu-item">
						<span>üë§ Mi perfil</span>
					</a>
					<a th:href="@{/editar-perfil}" class="user-menu-item">
						<span>‚úèÔ∏è Editar perfil</span>
					</a>
					<div class="user-menu-divider"></div>
					<a th:href="@{/logout}" class="user-menu-item user-menu-item-danger">
						<span>üö™ Cerrar sesi√≥n</span>
					</a>
				</div>
			</div>
		</div>
	</header>

	<div class="container">
		<nav class="sidebar">
			<ul class="sidebar-menu">
				<li class="menu-item">
					<a th:href="@{/admin/mi-perfil}" style="text-decoration: none; color: inherit;">
						<span>üë§</span> Mi Perfil
					</a>
				</li>
				<li class="menu-item active">
					<a th:href="@{/admin/vehiculos}" style="text-decoration: none; color: inherit;">
						<span>üöó</span> Veh√≠culos
					</a>
				</li>
				<li class="menu-item">
					<a th:href="@{/admin/inventario}" style="text-decoration: none; color: inherit;">
						<span>üì¶</span> Inventario
					</a>
				</li>
				<li class="menu-item">
					<a th:href="@{/admin/proveedor}" style="text-decoration: none; color: inherit;">
						<span>üè¢</span> Proveedor
					</a>
				</li>
				<li class="menu-item">
					<a th:href="@{/admin/clientes}" style="text-decoration: none; color: inherit;">
						<span>üë•</span> Clientes
					</a>
				</li>
				<li class="menu-item">
					<a th:href="@{/admin/reservas}" style="text-decoration: none; color: inherit;">
						<span>üìã</span> Reservas
					</a>
				</li>
				<li class="menu-item">
					<a th:href="@{/admin/pagos}" style="text-decoration: none; color: inherit;">
						<span>üí∞</span> Pagos
					</a>
				</li>
			</ul>
		</nav>

		<main class="main-content">
			<div class="page-header">
				<h2 class="page-title">Gesti√≥n de Veh√≠culos</h2>
				<a th:href="@{/admin/vehiculos/registrar}" class="btn btn-primary">Agregar Veh√≠culo</a>
			</div>

			<!-- Mensaje de resultados de b√∫squeda -->
			<div th:if="${searchTerm}" class="search-results-info">
				<p>Resultados de b√∫squeda para: "<span th:text="${searchTerm}"></span>"
					- <span th:text="${vehiculos.size()}"></span> veh√≠culos encontrados</p>
			</div>

			<div class="table-container">
				<div class="table-header">
					<h3 class="table-title">Veh√≠culos Disponibles</h3>
					<div class="table-actions">
						<form th:action="@{/admin/vehiculos/lista}" method="get" class="search-form">
							<div class="search-container">
								<input type="text" name="search" th:value="${searchTerm}"
									placeholder="Buscar veh√≠culos..." class="search-input">
								<button type="submit" class="btn btn-search">üîç</button>
								<a th:href="@{/admin/vehiculos/lista}" class="btn btn-clear" th:if="${searchTerm}"
									title="Limpiar b√∫squeda">‚ùå</a>
							</div>
						</form>
					</div>
				</div>

				<div class="table-wrapper">
					<table id="vehiculosTable">
						<thead>
							<tr>
								<th>ID</th>
								<th>Placa</th>
								<th>Marca</th>
								<th>Color</th>
								<th>Estado</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody id="tableBody">
							<tr th:each="vehiculo : ${vehiculos}">
								<td th:text="${vehiculo.id_vehiculo}"></td>
								<td th:text="${vehiculo.placa}"></td>
								<td th:text="${vehiculo.marca}"></td>
								<td th:text="${vehiculo.color}"></td>
								<td>
									<span class="status-indicator" th:text="${vehiculo.estadoVehiculo}"></span>
								</td>
								<td>
									<button class="btn-action btn-info btn-view-more"
										th:data-id="${vehiculo.id_vehiculo}" th:data-placa="${vehiculo.placa}"
										th:data-marca="${vehiculo.marca}" th:data-modelo="${vehiculo.modelo}"
										th:data-anio="${vehiculo.anio}" th:data-version="${vehiculo.version}"
										th:data-tipo="${vehiculo.tipoVehiculo}"
										th:data-transmision="${vehiculo.transmicion}"
										th:data-combustible="${vehiculo.combustible}" th:data-color="${vehiculo.color}"
										th:data-estado="${vehiculo.estadoVehiculo}"
										th:data-descripcion="${vehiculo.descripcion}"
										th:data-usuario-id="${vehiculo.usuario != null ? vehiculo.usuario.id_usuario : null}"
										th:data-usuario-nombre="${vehiculo.usuario != null ? vehiculo.usuario.nombre + ' ' + vehiculo.usuario.apellido : 'Sin asignar'}">
										Ver m√°s
									</button>
									<a th:href="@{/admin/vehiculos/editar/{id}(id=${vehiculo.id_vehiculo})}"
										class="btn-action btn-edit">Editar</a>
									<form th:action="@{/admin/vehiculos/eliminar/{id}(id=${vehiculo.id_vehiculo})}"
										method="post" style="display:inline;">
										<button type="submit" class="btn-action btn-delete"
											onclick="return confirm('¬øSeguro que deseas eliminar este veh√≠culo?')">
											Eliminar
										</button>
									</form>
								</td>
							</tr>

							<tr th:if="${vehiculos.empty}">
								<td colspan="6" style="text-align: center; padding: 2rem;">
									<span th:if="${searchTerm}">No se encontraron veh√≠culos que coincidan con tu
										b√∫squeda.</span>
									<span th:unless="${searchTerm}">No hay veh√≠culos registrados.</span>
								</td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- Controles de paginaci√≥n -->
				<div class="pagination-container" th:if="${vehiculos.size() > 10}">
					<div class="pagination-info">
						üìä Mostrando <span id="currentRange">1-10</span> de <span th:text="${vehiculos.size()}"></span>
						veh√≠culos
					</div>
					<div class="pagination-controls">
						<button class="btn-pagination btn-pagination-prev" onclick="changePage(-1)">
							‚Üê Anterior
						</button>
						<div class="pagination-numbers" id="paginationNumbers"></div>
						<button class="btn-pagination btn-pagination-next" onclick="changePage(1)">
							Siguiente ‚Üí
						</button>
					</div>
				</div>
			</div>

			<!-- MODAL PANTALLA COMPLETA -->
			<div id="modalVehiculo" class="modal">
				<div class="modal-content">
					<div class="modal-header">
						<h3>üìã Detalles completos del veh√≠culo</h3>
						<button class="close-modal">&times;</button>
					</div>
					<div class="modal-body">
						<div class="modal-grid">
							<div class="modal-section">
								<h4>üöó Informaci√≥n B√°sica</h4>
								<div class="modal-details">
									<div class="modal-detail">
										<span class="modal-label">ID:</span>
										<span id="modal-id">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">ID Due√±o:</span>
										<span id="modal-usuario-id">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Due√±o:</span>
										<span id="modal-usuario-nombre">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Placa:</span>
										<span id="modal-placa">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Marca:</span>
										<span id="modal-marca">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Modelo:</span>
										<span id="modal-modelo">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">A√±o:</span>
										<span id="modal-anio">-</span>
									</div>
								</div>
							</div>

							<div class="modal-section">
								<h4>‚öôÔ∏è Especificaciones T√©cnicas</h4>
								<div class="modal-details">
									<div class="modal-detail">
										<span class="modal-label">Versi√≥n:</span>
										<span id="modal-version">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Tipo de veh√≠culo:</span>
										<span id="modal-tipo">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Transmisi√≥n:</span>
										<span id="modal-transmision">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Combustible:</span>
										<span id="modal-combustible">-</span>
									</div>
								</div>
							</div>

							<div class="modal-section">
								<h4>üé® Caracter√≠sticas</h4>
								<div class="modal-details">
									<div class="modal-detail">
										<span class="modal-label">Color:</span>
										<span id="modal-color">-</span>
									</div>
									<div class="modal-detail">
										<span class="modal-label">Estado:</span>
										<span id="modal-estado" class="status-indicator">-</span>
									</div>
									<div class="modal-detail full-width">
										<span class="modal-label">Descripci√≥n:</span>
										<span id="modal-descripcion">-</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button class="btn btn-primary" onclick="cerrarModal()">Cerrar Vista de Detalles</button>
					</div>
				</div>
			</div>
		</main>
	</div>

	<script>
		// Dropdown de usuario en header (todas las instancias .user-menu de la p√°gina)
		document.addEventListener('DOMContentLoaded', function () {
			const userMenus = document.querySelectorAll('.user-menu');
			if (!userMenus.length) return;

			function closeAllMenus() {
				userMenus.forEach(m => m.classList.remove('open'));
			}

			userMenus.forEach(function (userMenu) {
				const toggle = userMenu.querySelector('.user-menu-toggle');
				if (!toggle) return;

				toggle.addEventListener('click', function (event) {
					event.stopPropagation();
					const isOpen = userMenu.classList.contains('open');
					closeAllMenus();
					if (!isOpen) {
						userMenu.classList.add('open');
					}
				});
			});

			document.addEventListener('click', function () {
				closeAllMenus();
			});
		});
	</script>
	<script>
		// Variables globales
		let modal = null;

		// Funci√≥n para abrir el modal con los datos del veh√≠culo
		function abrirModal(button) {
			console.log('Abriendo modal pantalla completa...');

			// Obtener los datos del bot√≥n clickeado
			const vehiculoData = {
				id: button.getAttribute('data-id') || 'N/A',
				placa: button.getAttribute('data-placa') || 'N/A',
				marca: button.getAttribute('data-marca') || 'N/A',
				modelo: button.getAttribute('data-modelo') || 'N/A',
				anio: button.getAttribute('data-anio') || 'N/A',
				version: button.getAttribute('data-version') || 'N/A',
				tipo: button.getAttribute('data-tipo') || 'N/A',
				transmision: button.getAttribute('data-transmision') || 'N/A',
				combustible: button.getAttribute('data-combustible') || 'N/A',
				color: button.getAttribute('data-color') || 'N/A',
				estado: button.getAttribute('data-estado') || 'N/A',
				descripcion: button.getAttribute('data-descripcion') || 'Sin descripci√≥n disponible',
				usuarioId: button.getAttribute('data-usuario-id') || 'Sin asignar',
				usuarioNombre: button.getAttribute('data-usuario-nombre') || 'Sin asignar'
			};

			console.log('Datos del veh√≠culo:', vehiculoData);

			// Llenar el modal con los datos
			const fillField = (id, value) => {
				const element = document.getElementById(id);
				if (element) element.textContent = value;
			};

			fillField('modal-id', vehiculoData.id);
			fillField('modal-usuario-id', vehiculoData.usuarioId);
			fillField('modal-usuario-nombre', vehiculoData.usuarioNombre);

			fillField('modal-placa', vehiculoData.placa);
			fillField('modal-marca', vehiculoData.marca);
			fillField('modal-modelo', vehiculoData.modelo);
			fillField('modal-anio', vehiculoData.anio);
			fillField('modal-version', vehiculoData.version);
			fillField('modal-tipo', vehiculoData.tipo);
			fillField('modal-transmision', vehiculoData.transmision);
			fillField('modal-combustible', vehiculoData.combustible);
			fillField('modal-color', vehiculoData.color);
			fillField('modal-descripcion', vehiculoData.descripcion);

			// Configurar el estado con la clase correspondiente
			const estadoElement = document.getElementById('modal-estado');
			if (estadoElement) {
				const estadoTexto = (vehiculoData.estado || '').trim();
				const estadoLower = estadoTexto.toLowerCase();
				estadoElement.textContent = estadoTexto;

				// Remover clases anteriores y agregar la nueva seg√∫n el estado
				estadoElement.className = 'status-indicator';
				if (estadoLower === 'disponible') {
					estadoElement.classList.add('status-available');
				} else if (estadoLower === 'mantenimiento') {
					estadoElement.classList.add('status-maintenance');
				} else {
					estadoElement.classList.add('status-rented');
				}
			}

			// Mostrar el modal
			if (modal) {
				// Asegurar que la ventana se posicione al inicio para ver el modal completo
				window.scrollTo({ top: 0, behavior: 'auto' });
				modal.style.display = 'block';
				document.body.style.overflow = 'hidden'; // Prevenir scroll del body
			}
		}

		// Funci√≥n para cerrar el modal
		function cerrarModal() {
			if (modal) {
				modal.style.display = 'none';
				document.body.style.overflow = 'auto'; // Restaurar scroll
			}
		}

		// Inicializar cuando el DOM est√© cargado
		document.addEventListener('DOMContentLoaded', function () {
			console.log('Inicializando modal pantalla completa...');

			// Inicializar modal
			modal = document.getElementById('modalVehiculo');

			if (!modal) {
				console.error('‚ùå No se encontr√≥ el modal');
				return;
			}

			console.log('‚úÖ Modal pantalla completa encontrado');

			// Agregar event listeners a todos los botones "Ver m√°s"
			const viewMoreButtons = document.querySelectorAll('.btn-view-more');
			console.log(`‚úÖ Encontrados ${viewMoreButtons.length} botones "Ver m√°s"`);

			viewMoreButtons.forEach((button, index) => {
				button.addEventListener('click', function (event) {
					event.preventDefault();
					event.stopPropagation();
					console.log(`üñ±Ô∏è Click en bot√≥n Ver m√°s #${index + 1}`);
					abrirModal(this);
				});
			});

			// Cerrar modal al hacer clic fuera del contenido
			modal.addEventListener('click', function (event) {
				if (event.target === modal) {
					cerrarModal();
				}
			});

			// Cerrar modal con la tecla ESC
			document.addEventListener('keydown', function (event) {
				if (event.key === 'Escape') {
					cerrarModal();
				}
			});

			// Cerrar modal con el bot√≥n X
			const closeButton = document.querySelector('.close-modal');
			if (closeButton) {
				closeButton.addEventListener('click', function (event) {
					event.preventDefault();
					cerrarModal();
				});
			}

			console.log('‚úÖ Modal pantalla completa inicializado');
		});
	</script>
	<script>
		// Variables de paginaci√≥n
		let currentPage = 1;
		const rowsPerPage = 10;
		let allRows = [];

		// Funci√≥n para inicializar la paginaci√≥n
		function initializePagination() {
			console.log('Inicializando paginaci√≥n...');

			// Obtener todas las filas de la tabla (excluyendo la fila de "no resultados")
			const tableBody = document.getElementById('tableBody');
			allRows = Array.from(tableBody.querySelectorAll('tr')).filter(row =>
				!row.querySelector('td[colspan]') // Excluir filas con colspan (mensajes de no resultados)
			);

			const totalRows = allRows.length;
			console.log(`Total de filas: ${totalRows}`);

			// Si hay m√°s de 10 filas, inicializar paginaci√≥n
			if (totalRows > rowsPerPage) {
				setupPagination(totalRows);
				showPage(1);
			} else {
				// Si hay 10 o menos filas, mostrar todas y ocultar controles de paginaci√≥n
				document.querySelector('.pagination-container').style.display = 'none';
				allRows.forEach(row => row.style.display = '');
				updateRangeInfo(1, totalRows, totalRows);
			}

			// Aplicar estilos de estado a las filas visibles
			applyStatusStyles();
		}

		// Funci√≥n para configurar la paginaci√≥n
		function setupPagination(totalRows) {
			const totalPages = Math.ceil(totalRows / rowsPerPage);
			const paginationNumbers = document.getElementById('paginationNumbers');
			paginationNumbers.innerHTML = '';

			// Siempre mostrar primera p√°gina
			addPageNumber(1, paginationNumbers);

			// Mostrar puntos suspensivos si hay muchas p√°ginas
			if (currentPage > 3) {
				addDots(paginationNumbers);
			}

			// Mostrar p√°ginas alrededor de la actual
			const startPage = Math.max(2, currentPage - 1);
			const endPage = Math.min(totalPages - 1, currentPage + 1);

			for (let i = startPage; i <= endPage; i++) {
				if (i !== 1 && i !== totalPages) {
					addPageNumber(i, paginationNumbers);
				}
			}

			// Mostrar puntos suspensivos si hay muchas p√°ginas
			if (currentPage < totalPages - 2) {
				addDots(paginationNumbers);
			}

			// Siempre mostrar √∫ltima p√°gina si hay m√°s de 1 p√°gina
			if (totalPages > 1) {
				addPageNumber(totalPages, paginationNumbers);
			}

			// Actualizar botones anterior/siguiente
			updateNavigationButtons(totalPages);
		}

		// Funci√≥n para agregar n√∫mero de p√°gina
		function addPageNumber(pageNumber, container) {
			const pageElement = document.createElement('button');
			pageElement.className = `page-number ${pageNumber === currentPage ? 'active' : ''}`;
			pageElement.textContent = pageNumber;
			pageElement.onclick = () => showPage(pageNumber);
			container.appendChild(pageElement);
		}

		// Funci√≥n para agregar puntos suspensivos
		function addDots(container) {
			const dots = document.createElement('span');
			dots.className = 'page-number dots';
			dots.textContent = '...';
			container.appendChild(dots);
		}

		// Funci√≥n para mostrar una p√°gina espec√≠fica
		function showPage(page) {
			currentPage = page;
			const startIndex = (page - 1) * rowsPerPage;
			const endIndex = startIndex + rowsPerPage;

			// Ocultar todas las filas
			allRows.forEach(row => row.style.display = 'none');

			// Mostrar solo las filas de la p√°gina actual
			for (let i = startIndex; i < endIndex && i < allRows.length; i++) {
				if (allRows[i]) {
					allRows[i].style.display = '';
				}
			}

			// Actualizar informaci√≥n del rango
			const actualEnd = Math.min(endIndex, allRows.length);
			updateRangeInfo(startIndex + 1, actualEnd, allRows.length);

			// Actualizar controles de paginaci√≥n
			setupPagination(allRows.length);

			// Re-aplicar estilos de estado
			applyStatusStyles();
		}

		// Funci√≥n para cambiar de p√°gina (anterior/siguiente)
		function changePage(direction) {
			const totalPages = Math.ceil(allRows.length / rowsPerPage);
			const newPage = currentPage + direction;

			if (newPage >= 1 && newPage <= totalPages) {
				showPage(newPage);
			}
		}

		// Funci√≥n para actualizar botones de navegaci√≥n
		function updateNavigationButtons(totalPages) {
			const prevBtn = document.querySelector('.btn-pagination-prev');
			const nextBtn = document.querySelector('.btn-pagination-next');

			prevBtn.disabled = currentPage === 1;
			nextBtn.disabled = currentPage === totalPages;
		}

		// Funci√≥n para actualizar informaci√≥n del rango
		function updateRangeInfo(start, end, total) {
			document.getElementById('currentRange').textContent = `${start}-${end}`;
		}

		// Funci√≥n para aplicar estilos de estado
		function applyStatusStyles() {
			document.querySelectorAll('tbody tr').forEach(row => {
				const estadoElement = row.querySelector('.status-indicator');
				if (estadoElement && row.style.display !== 'none') {
					const estadoTexto = estadoElement.textContent.trim();
					const estadoLower = estadoTexto.toLowerCase();
					estadoElement.className = 'status-indicator';
					if (estadoLower === 'disponible') {
						estadoElement.classList.add('status-available');
					} else if (estadoLower === 'mantenimiento') {
						estadoElement.classList.add('status-maintenance');
					} else {
						estadoElement.classList.add('status-rented');
					}
				}
			});
		}

		// Inicializar cuando el DOM est√© cargado
		document.addEventListener('DOMContentLoaded', function () {
			console.log('Inicializando sistema...');

			// Inicializar paginaci√≥n
			initializePagination();

			// El resto de tu c√≥digo de inicializaci√≥n del modal...
			// (mant√©n tu c√≥digo existente de inicializaci√≥n del modal aqu√≠)
		});
	</script>
</body>

</html>